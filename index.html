<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="global.css">
    <link rel="stylesheet" href="custom-checkbox.css">
    <link rel="stylesheet" href="tui-assets/css/tui-custom.css">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;1,100;1,200;1,300;1,400&family=Quicksand:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- CDN -->
    <link rel="stylesheet" href="tui-assets/css/toastui-calendar.min.css" />
    <!-- tui -->
    <link rel="stylesheet" href="tui-assets/css/tui-date-picker.css">
    <link rel="stylesheet" href="tui-assets/css/tui-time-picker.css">
    <link rel="stylesheet" href="autocomplete-input.css">
</head>

<body>
    <div class="calendar-container">
        <div class="left-side">
            <div class="calendar">
                <div class="month">
                    <div class="time-n-date">
                        <p id="c-time">00:00:00</p>
                        <span id="c-date">Fri May 29, 2022</span>
                    </div>
                    <div class="current-date">
                        <div class="month-year">
                            <h1 id="c-month">MonthName</h1>
                            <h1 id="c-year">Year</h1>
                        </div>
                        <div class="pagination">
                            <i class="fas fa-arrow-up prev" id="prev"></i>
                            <i class="fas fa-arrow-down next" id="next"></i>
                        </div>
                    </div>
                </div>
                <div class="weekdays">
                    <div>Sun</div>
                    <div>Mon</div>
                    <div>Tue</div>
                    <div>Wed</div>
                    <div>Thu</div>
                    <div>Fri</div>
                    <div>Sat</div>
                </div>
                <div class="days">
                    <!-- displays dates here -->
                </div>
            </div>
            <div class="other-menu">
                <div class="calendars-container">
                    <!-- Calendars list -->
                    <fieldset class="calendars">
                        <legend class="calendars-title" cdata-key="calendars">Calendars</legend>
                        <div class="calendars-list" id="calendars-list">
                            <div class="calendars-item">
                                <div class="checkbox-wrapper-18">
                                    <div class="round">
                                        <input type="checkbox" id="checkbox-18"/>
                                        <label for="checkbox-18"></label>
                                    </div>
                                </div>
                                <label for="checkbox-18">Calendar item</label>
                            </div>
                        </div>
                    </fieldset>

                    <fieldset class="calendars">
                        <legend class="calendars-title" cdata-key="mycalendars">Calendars</legend>
                        <div class="my-calendar-search">
                            <i class="fas fa-search"></i>
                            <input type="search" placeholder="Search calendar" oninput="searchMyCalendar(this)"
                                cdata-key="mycalendar_search_placeholder">
                        </div>
                        <div class="calendars-list" id="my-calendars-list">
                            <div class="calendars-item">    
                                <div class="checkbox-wrapper-18">
                                    <div class="round">
                                        <input type="checkbox" id="checkbox-18" />
                                        <label for="checkbox-18">
                                            <span class="check-icon"></span>
                                        </label>
                                    </div>
                                </div>
                                <label for="checkbox-18">Calendar item</label>
                            </div>
                        </div>
                    </fieldset>
                </div>
                <div class="add-calendars-form">
                    <button class="calendars-add" id="add-calendar" modal-target="#add-calendar-modal">
                        <i class="fas fa-plus"></i>
                        <span cdata-key="add_calendar">Add Calendar</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="timetable">
            <div class="options">
                <div class="day-switcher">
                    <div class="day-switcher-buttons">
                        <button id="day-prev">
                            <i class="fas fa-angle-left fa-lg"></i>
                        </button>
                        <button id="day-next">
                            <i class="fas fa-angle-right fa-lg"></i>
                        </button>
                    </div>
                    <h1>Today</h1>
                </div>
                <div class="others">
                    <div class="add-event-form">
                        <button type="button">
                            <i class="fas fa-plus"></i>
                            <span cdata-key="add_event" id="add-event-button">Add event</span>
                        </button>
                    </div>
                    <div class="calendar-other-options">
                        <label class="option-item">
                            <input type="checkbox" id="show-task">
                            <span cdata-key="show_task">Show task</span>
                        </label>
                        <label class="option-item">
                            <input type="checkbox" id="show-currenttime" checked>
                            <span cdata-key="show_current_time">Show current time</span>
                        </label>
                        <label class="option-item">
                            <input type="checkbox" id="work-week" checked>
                            <span cdata-key="workweek">Narrow weekend</span>
                        </label>
                    </div>
                    <div class="calendar-view-options">
                        <label class="option-item">
                            <input type="radio" name="default-view" value="day" checked>
                            <span cdata-key="day">Day</span>
                        </label>
                        <label class="option-item">
                            <input type="radio" name="default-view" value="week">
                            <span cdata-key="week">Week</span>
                        </label>
                        <label class="option-item">
                            <input type="radio" name="default-view" value="month">
                            <span cdata-key="month">Month</span>
                        </label>
                    </div>
                </div>
            </div>
            <div id="c-calendar">

            </div>
        </div>

        <!-- Add calendar form -->
        <div class="calendar-modal" id="add-calendar-modal">
            <form id="add-calendar-form" class="add-calendar-form toastui-calendar-form-container">
                <h2 class="form-title" cdata-key="add_calendar">Add Calendar</h2>

                <div class="toastui-calendar-popup-section-item toastui-calendar-popup-section-title">
                    <span class="toastui-calendar-icon toastui-calendar-ic-title"></span>
                    <input type="text" id="calendar-name-input" class="toastui-calendar-content" required
                        placeholder="Calendar name" cdata-key="calendar_name_placeholder">
                </div>

                <div
                    class="toastui-calendar-popup-section toastui-calendar-dropdown-section toastui-calendar-calendar-section">
                    <button type="button"
                        class="toastui-calendar-popup-section-item toastui-calendar-popup-button calendar-theme-dropdown">
                        <span class="toastui-calendar-icon toastui-calendar-dot calendar-theme-shape"
                            style="background-color: #EC148F;" id="calendar-theme-selected"></span>
                        <span class="toastui-calendar-content toastui-calendar-event-calendar"
                            cdata-key="theme">Theme</span>
                        <span class="toastui-calendar-icon toastui-calendar-ic-dropdown-arrow"></span>
                    </button>
                    <ul class="toastui-calendar-dropdown-menu calendar-theme-list">
                        <li class="toastui-calendar-dropdown-menu-item">
                            <input type="color" value="#ffffff" class="calendar-color_picker"
                                placeholder="Customize color" cdata-key="customize_theme_placeholder">
                        </li>
                    </ul>
                </div>

                <button type="button" class="toastui-calendar-popup-button toastui-calendar-popup-close"
                    modal-close="#add-calendar-modal">
                    <i class="toastui-calendar-icon toastui-calendar-ic-close"></i>
                </button>
                <div class="toastui-calendar-popup-section">
                    <button type="submit" class="toastui-calendar-popup-button toastui-calendar-popup-confirm">
                        <span>
                            <div class="toastui-calendar-template-popupSave" cdata-key="add">Ajouter</div>
                        </span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Edit calendar form -->
        <div class="calendar-modal" id="edit-calendar-modal">
            <form id="edit-calendar-form" class="add-calendar-form toastui-calendar-form-container">
                <h2 class="form-title" cdata-key="edit_calendar">Edit Calendar</h2>

                <div class="toastui-calendar-popup-section-item toastui-calendar-popup-section-title">
                    <span class="toastui-calendar-icon toastui-calendar-ic-title"></span>
                    <input type="text" id="edit-calendar-name-input" class="toastui-calendar-content" required
                        placeholder="Calendar name" cdata-key="calendar_name_placeholder">
                    <input type="hidden" id="edit-calendar-id">
                </div>

                <div
                    class="toastui-calendar-popup-section toastui-calendar-dropdown-section toastui-calendar-calendar-section">
                    <button type="button"
                        class="toastui-calendar-popup-section-item toastui-calendar-popup-button calendar-theme-dropdown">
                        <span class="toastui-calendar-icon toastui-calendar-dot calendar-theme-shape"
                            style="background-color: #EC148F;" id="edit-calendar-theme-selected"></span>
                        <span class="toastui-calendar-content toastui-calendar-event-calendar"
                            cdata-key="theme">Theme</span>
                        <span class="toastui-calendar-icon toastui-calendar-ic-dropdown-arrow"></span>
                    </button>
                    <ul class="toastui-calendar-dropdown-menu calendar-theme-list">
                        <li class="toastui-calendar-dropdown-menu-item">
                            <input type="color" value="#ffffff" class="calendar-color_picker"
                                placeholder="Customize color" cdata-key="customize_theme_placeholder">
                        </li>
                    </ul>
                </div>
                <button type="button" class="toastui-calendar-popup-button toastui-calendar-popup-close"
                    modal-close="#edit-calendar-modal">
                    <i class="toastui-calendar-icon toastui-calendar-ic-close"></i>
                </button>
                <div class="toastui-calendar-popup-section">
                    <button type="submit" class="toastui-calendar-popup-button toastui-calendar-popup-confirm">
                        <span>
                            <div class="toastui-calendar-template-popupSave" cdata-key="update">Ajouter</div>
                        </span>
                    </button>
                </div>
            </form>
        </div>

        <!-- Delete calendar form -->
        <div class="calendar-modal" id="delete-calendar-modal">
            <form id="delete-calendar-form" class="add-calendar-form toastui-calendar-form-container">
                <h2 class="form-title" cdata-key="delete_calendar">Delete calendar</h2>
                <h3 class="calendar-name"><span id="delete-calendar-name">Birthday</span></h3>
                <input type="hidden" id="delete-calendar-id">
                <p class="delete-calendar-message" cdata-key="delete_calendar_message">Be carefull, all events in this
                    calendar will be deleted too. Do you want to delete anyway?</p>
                <button type="button" class="toastui-calendar-popup-button toastui-calendar-popup-close"
                    modal-close="#delete-calendar-modal">
                    <i class="toastui-calendar-icon toastui-calendar-ic-close"></i>
                </button>
                <div class="toastui-calendar-popup-section">
                    <button type="submit" class="toastui-calendar-popup-button toastui-calendar-popup-confirm">
                        <span>
                            <div class="toastui-calendar-template-popupSave" cdata-key="delete">Delete</div>
                        </span>
                    </button>
                    <button type="button"
                        class="toastui-calendar-popup-button toastui-calendar-popup-confirm toastui-calendar-popup-cancel"
                        modal-close="#delete-calendar-modal">
                        <span>
                            <div class="toastui-calendar-template-popupSave" cdata-key="no_cancel">Delete</div>
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast-alert">
        <p>Event updated successfully</p>
    </div>
    <!-- with CDN and browser environment namespace -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="tui-assets/js/tui-time-picker.js"></script>
    <script src="tui-assets/js/tui-date-picker.js"></script>
    <script src="tui-assets/js/toastui-calendar.ie11.min.js"></script>
    <!-- <script src="https://uicdn.toast.com/calendar/latest/toastui-calendar.min.js"></script> -->
    <script src="utils/autocomplete-input.js"></script>
    <script src="utils/global-functions.js"></script>
    <script>
        const Calendar = tui.Calendar;
        const container = document.getElementById('c-calendar');
        const currentTz = Intl.DateTimeFormat().resolvedOptions().timeZone;
        const events = [
            {
                id: 'event1',
                calendarId: 'cal2',
                title: 'Weekly meeting',
                start: '2023-12-07T09:00:00',
                end: '2023-12-07T10:00:00',
            },
            {
                id: 'event2',
                calendarId: 'cal1',
                title: 'Lunch appointment',
                start: '2023-12-08T07:00:00',
                end: '2023-12-08T10:00:00',
            },
            {
                id: 'event3',
                calendarId: 'cal3',
                title: 'Vacation',
                start: '2023-12-10T09:00:00',
                end: '2023-12-10T12:00:00',
                attendees: ['Me'],
                // isAllday: true,
                // category: 'allday',
            },

            {
                id: 'event4',
                calendarId: 'cal1',
                title: 'timed event',
                body: 'TOAST UI Calendar',
                start: '2023-12-01T10:00:00',
                end: '2023-12-01T11:00:00',
                location: 'Meeting Room A',
                attendees: ['A', 'B', 'C'],
                category: 'time',
                state: 'Free',
                isReadOnly: true,
                color: '#fff',
                backgroundColor: '#ccc',
                customStyle: {
                    fontStyle: 'italic',
                    fontSize: '15px',
                },
            }, // EventObject
        ];

        const options = {
            defaultView: 'day',
            isReadOnly: false,
            usageStatistics: false,
            timezone: {
                zones: [
                    {
                        timezoneName: currentTz,
                        displayLabel: 'Timezone',
                    },
                ],
            },
            calendars: DEFAULT_CALENDARS,
            useFormPopup: true,
            useDetailPopup: true
        };

        const calendar = new Calendar(container, options);
        calendar.createEvents(events)

        calendar.setOptions({
            week: {
                startDayOfWeek: new Date().getDay()
            }
        });

        // get calendars
        var calendarInnerHTML = DEFAULT_CALENDARS.map(calendar => {
            return `
            <div class="calendars-item">
                <div class="checkbox-wrapper-18">
                    <div class="round">
                        <input type="checkbox" id="${calendar.id}" checked value="${calendar.id}"/>
                        <label for="${calendar.id}" style="background-color: ${calendar.backgroundColor};border-color: ${calendar.backgroundColor}">
                            <span class="check-icon" style="border-color: ${calendar.color} !important;"></span>
                        </label>
                    </div>
                </div>
                <label for="${calendar.id}">${calendar.name}</label>
            </div>`;
        }).join('')

        document.querySelector('#calendars-list').innerHTML = calendarInnerHTML;

        // update calendar by stored options
        calendar.changeView(CalendarView.get());
        hideOtherOptions(CalendarView.get());
        calendar.setOptions({
            week: {
                taskView: TasksView.get(),
                showNowIndicator: CurrentTimeVisibility.get(),
                workweek: WorkWeek.get(),
                // week
                eventView: true, // or ['allday', 'time', 'milestone']
            }
        });
        document.querySelector('#show-task').checked = TasksView.get();
        document.querySelector('#show-currenttime').checked = CurrentTimeVisibility.get();
        document.querySelector('#work-week').checked = WorkWeek.get();

        // event to change default view
        [...document.getElementsByName('default-view')].forEach(input => {
            // activate calendar view accordings to the stored option
            input.checked = CalendarView.get() === input.value;

            input.addEventListener('click', () => {
                const view = input.value;
                hideOtherOptions(view);
                calendar.changeView(view)
                CalendarView.set(view);
            });
        });

        // Show task in calendar. event handler
        document.querySelector('#show-task').addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            calendar.setOptions({
                week: {
                    taskView: isChecked,
                }
            });
            calendar.render();

            TasksView.set(isChecked);
        });

        // Show current time in calendar. event handler
        document.querySelector('#show-currenttime').addEventListener('change', (e) => {
            calendar.setOptions({
                week: {
                    showNowIndicator: e.target.checked,
                }
            });
            CurrentTimeVisibility.set(e.target.checked);
        });

        // Calendar narrow weekend
        document.querySelector('#work-week').addEventListener('click', (e) => {
            calendar.setOptions({
                week: {
                    workweek: e.target.checked,
                }
            });
            WorkWeek.set(e.target.checked);
        });

        // Calendar check event 800 1100 1400
        document.querySelectorAll('#calendars-list input[type="checkbox"]').forEach(input => {
            input.addEventListener('change', () => {
                const isChecked = input.checked;
                calendar.setCalendarVisibility(input.value, isChecked);
            });
        });

        /* POSITIONING DIALOG */
        const leftSide = document.querySelector('.left-side');
        // set position of event details
        calendar.on('clickEvent', (eventInfo) => {
            // remove selection in the calendar
            calendar.clearGridSelections();

            const { event } = eventInfo;
            console.log(event.attendees)
            const rect = container.getBoundingClientRect();
            setTimeout(() => {

                const dialog = document.querySelector('div[role="dialog"].toastui-calendar-popup-container');
                let dialogTop = parseFloat(dialog.style.top.replace('px', ''));
                let dialogLeft = parseFloat(dialog.style.left.replace('px', ''));;
                // set top 
                dialog.style.top = `${Math.abs(dialogTop - rect.top - scrollY)}px`;
                let rectLeft = rect.left > 0 ? rect.left - leftSide.clientWidth : 0;
                dialog.style.left = `${Math.abs(dialogLeft - rectLeft - scrollX)}px`;

                const editBtn = dialog.querySelector('button.toastui-calendar-edit-button');
                editBtn.addEventListener('click', () => {
                    setTimeout(() => {
                        const dialog = document.querySelector('div[role="dialog"].toastui-calendar-popup-container');
                        const button = dialog.querySelector('button.toastui-calendar-popup-button.toastui-calendar-popup-close');
                        // append category option
                        let div = document.createElement('div');
                        div.className = 'custom-popup-section';
                        div.append(attendeeTemplate(event.attendees));
                        div.append(categoryOptionTemplate(event.category));
                        button.before(div);
                        initAutoComplete();
                        let dialogTop = parseFloat(dialog.style.top.replace('px', ''));
                        let dialogLeft = parseFloat(dialog.style.left.replace('px', ''));;
                        // set top 
                        dialog.style.top = `${Math.abs(dialogTop - rect.top - scrollY)}px`;
                        let rectLeft = rect.left > 0 ? rect.left - leftSide.clientWidth : 0;
                        dialog.style.left = `${Math.abs(dialogLeft - rectLeft - scrollX)}px`;
                    }, 10);
                })
            }, 10);
        });
        // set dialog position while creating event by clicking
        calendar.on('selectDateTime', (eventInfo) => {
            const rect = container.getBoundingClientRect();
            setTimeout(() => {
                const dialog = document.querySelector('div[role="dialog"].toastui-calendar-popup-container');
                const button = dialog.querySelector('button.toastui-calendar-popup-button.toastui-calendar-popup-close');
                // append category option
                let div = document.createElement('div');
                div.className = 'custom-popup-section';
                div.append(attendeeTemplate());
                div.append(categoryOptionTemplate(eventInfo.isAllday ? 'allday' : 'time'));
                button.before(div);
                initAutoComplete();

                let dialogTop = parseFloat(dialog.style.top.replace('px', '') || 0);
                let dialogLeft = parseFloat(dialog.style.left.replace('px', '') || 0);;
                // set top 
                dialog.style.top = `${Math.abs(dialogTop - rect.top - scrollY)}px`;
                let rectLeft = rect.left > 0 ? rect.left - leftSide.clientWidth : 0;
                dialog.style.left = `${Math.abs(dialogLeft - rectLeft - scrollX)}px`;
            }, 10);
        });

        // add event button
        document.getElementById('add-event-button').addEventListener('click', (e) => {
            const rect = container.getBoundingClientRect();
            console.log(e)
            calendar.openFormPopup({
                start: new Date().toISOString(),
                end: new Date().toISOString()
            }); 
            setTimeout(() => {
                const dialog = document.querySelector('div[role="dialog"].toastui-calendar-popup-container');
                const button = dialog.querySelector('button.toastui-calendar-popup-button.toastui-calendar-popup-close');
                const arrow = dialog.querySelector('.toastui-calendar-popup-arrow.toastui-calendar-bottom');
                arrow.setAttribute('hidden', '');

                // append category option
                let div = document.createElement('div');
                div.className = 'custom-popup-section';
                div.append(attendeeTemplate());
                div.append(categoryOptionTemplate());
                button.before(div);
                initAutoComplete();

                let dialogTop = e.pageY;
                let dialogLeft = e.pageX - (dialog.clientWidth / 2);
                // set top 
                dialog.style.top = `${Math.abs(dialogTop)}px`;
                dialog.style.left = `${Math.abs(dialogLeft)}px`;
            }, 10);
        });

        // document.addEventListener('re', () => {
            const resizeObserver = new ResizeObserver(entries => {
                entries.map(entry => {
                    let myCalendars_div = document.getElementById('my-calendars-list')
                    console.log(myCalendars_div.clientHeight)
                    myCalendars_div.style.maxHeight = `${myCalendars_div.clientHeight}px`;
                })
            });

            resizeObserver.observe(document.body)
        // });

    </script>
    <script src="utils/calendar-lang.js"></script>
    <script src="utils/calendar-toast.js"></script>
    <script src="utils/calendar-events-handler.js"></script>
    <script src="utils/calendar-theme.js"></script>
    <script src="utils/calendar.js"></script>
</body>

</html>